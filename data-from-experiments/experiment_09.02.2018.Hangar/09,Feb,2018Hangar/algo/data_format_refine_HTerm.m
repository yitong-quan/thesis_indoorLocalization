%% refinde the .txt file generated by HTerm when Time stamp is present
% the data recorded in the .txt file from HTerm sometimes contains an
% unexpected new lines and unexpected time stamps between the distance 
% data  from different nodes
% This file refines the .txt file by deleted the unwanted lines and 
% unexpected time stamps by judging if time_interval < 0.3 of not.
%% pseudocode
%{
% import_file;
% last_time = 00:00:00.000;
% read line_by_line
%     if (time_format)
%         this_time = read_time_of_this_line;
%         time_interval = this_time - last_time;
%         if time_interval < 0.3
%             flag_combination = 1; <<<<<<<<<<<<<<<<<<<<<<<<
%             do_nothing;
%         else
%             flag_combination = 0;
%             write_this_time_to_file(begin with '\n');
%         end
%         last_time = this_time;
%     elseif (begine_with '0x')
%         write_this_time_to_file(begin with '\n');
%     elseif (empty line)
%         write_empty_line_to_file;
%     else % begin with something else than 'time_format' or '0x'
%         if flag_combination == 1
%             write_this_time_to_file(begin without '\n');
%         end
%     end
%}
%%
clear;
experimentNum = 1;
last_time = '00:00:00.000:';

switch experimentNum
    case 1
        fileName = 'data_all - Copy';
    otherwise
        warning('please specify the experiment number #')
end
path = '..\';
fileID_r = fopen([path, fileName, '.log'], 'r');
fileID_w =fopen([path, fileName, '_refined.log'], 'w');

tline = fgetl(fileID_r); % format char
time_format = '^[0-9]+:[0-9]+:[0-9]+\.[0-9]+';
flag_combination = 0; % flag for combining distance data of two different time stamps
while ischar(tline)
    if regexp(tline, time_format) == 1 % begin with 'time_format'
        this_time = tline;
        time_interval = etime(datevec(this_time),datevec(last_time));
        if time_interval < 0.3
            flag_combination = 1; 
        else
            flag_combination = 0;
           % write_this_time_to_file (begin with '\n');
            fprintf(fileID_w, '\r\n\r\n%s', tline);
        end
        last_time = this_time;
    elseif  strncmp(tline, '0x', 2) % (begine_with '0x')
        fprintf(fileID_w, '\r\n%s', tline);
    elseif  strncmp(tline, '0', 1) && flag_combination == 0% (begine_with '0x')
        fprintf(fileID_w, '\r\n%s', tline);
    else % begin with something else than 'time_format' or '0x'
        if flag_combination == 1
            fprintf(fileID_w, '%s', tline);
        end
    end
    tline = fgetl(fileID_r);
end
fclose(fileID_w);
fclose(fileID_r);


